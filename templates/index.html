<!DOCTYPE html>
<html>
<head>
    <title>Knowledge Graph Visualization & Query</title>
    <!-- Vis.js CSS -->
    <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
    <!-- Bootstrap for responsive layout -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html, body {
            height: 100%; /* Ensure html and body take full viewport height */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars on body if content fits */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column; /* Stack elements vertically */
        }

        .navbar {
            background-color: #343a40;
            /* color: white;  Removed, set on brand directly */
            padding: 0.5rem 1rem;
            flex-shrink: 0; /* Prevent navbar from shrinking */
            z-index: 10; /* Keep navbar above other content if overlap occurs */
        }

        /* Ensure navbar brand text is white */
        .navbar .navbar-brand {
             color: white !important; /* Force white color */
        }


        .main-content-area {
            padding: 20px;
            flex-grow: 1; /* Allow this area to take up remaining vertical space */
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow scrolling within this area if needed, not on body */
            min-height: 0; /* Important for flex-grow in column layout */
        }

        #graph-container {
            width: 100%;
            flex-grow: 1; /* Allow graph container to expand vertically */
            min-height: 400px; /* Maintain a reasonable minimum height */
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px; /* Space below graph */
        }

        .query-section {
            flex-shrink: 0; /* Prevent query section from shrinking */
            margin-bottom: 15px; /* Space below query section */
        }

        .card {
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card-header {
            background-color: #f1f3f5;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        #query-result {
            min-height: 60px; /* Slightly reduced min-height */
            max-height: 150px; /* Add max-height to prevent excessive growth */
            overflow-y: auto; /* Allow scrolling for long answers */
            border: 1px solid #dee2e6;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .status-bar {
            padding: 10px;
            border-radius: 4px;
            flex-shrink: 0; /* Prevent status bar from shrinking */
            margin-top: auto; /* Push status bar towards the bottom within main-content-area */
            position: sticky; /* Keep status bar potentially visible */
            bottom: 0;      /* Stick to bottom if scrolling */
            background-color: #f8f9fa; /* Match body background */
            z-index: 5; /* Keep above graph if overlapping */
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb; /* Add border for definition */
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb; /* Add border for definition */
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            border-radius: 4px;
        }

    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <span class="navbar-brand mb-0 h1">Knowledge Graph Visualization & Query</span>
        </div>
    </nav>

    <!-- Wrap main content to manage flex growth and scrolling -->
    <div class="main-content-area">
        <!-- Graph Visualization -->
        <div id="graph-container"></div>

        <!-- Query Panel -->
        <div class="query-section card">
            <div class="card-header">Query the Knowledge Graph</div>
            <div class="card-body">
                <div class="form-group">
                    <input type="text" id="query-input" class="form-control" placeholder="Ask a question about the knowledge graph...">
                </div>
                <button id="submit-query" class="btn btn-primary">Submit Query</button>
                <div id="query-result">Waiting for query...</div>
            </div>
        </div>

        <!-- Status Bar -->
        <div id="status" class="status-bar info">Initializing...</div>
    </div> <!-- End main-content-area -->


    <!-- Socket.IO Client Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <!-- Vis.js Network Library -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- Main JavaScript -->
    <script type="text/javascript">
        // Global variables
        const socket = io(); // Connect to Socket.IO server
        let network = null;
        let nodes = new vis.DataSet([]);
        let edges = new vis.DataSet([]);

        // DOM Elements
        const statusDiv = document.getElementById('status');
        const graphContainer = document.getElementById('graph-container');
        const queryInput = document.getElementById('query-input');
        const submitQueryBtn = document.getElementById('submit-query');
        const queryResult = document.getElementById('query-result');

        // Initialize Graph Visualization
        function initializeGraph() {
            const data = { nodes: nodes, edges: edges };
            const options = {
                // Vis.js options remain largely the same
                layout: {}, // Use default physics layout initially
                nodes: {
                    shape: 'box',
                    font: { size: 14, face: 'arial' },
                    borderWidth: 1,
                    shapeProperties: { borderRadius: 3 },
                    margin: 10
                },
                edges: {
                    arrows: { to: { enabled: true, scaleFactor: 0.7 } },
                    font: { size: 12, align: 'middle' },
                    color: { inherit: false, color: '#848484', highlight:'#848484', hover: '#848484', opacity:1.0 },
                    smooth: { type: 'cubicBezier', forceDirection: 'vertical', roundness: 0.4 }
                },
                physics: {
                    enabled: true,
                    solver: 'barnesHut',
                    barnesHut: { gravitationalConstant: -4000, centralGravity: 0.15, springLength: 130, springConstant: 0.06, damping: 0.15 },
                    stabilization: { iterations: 150 }
                },
                interaction: {
                    tooltipDelay: 200,
                    hover: true,
                    zoomView: true,
                    dragView: true
                }
            };
            network = new vis.Network(graphContainer, data, options);

            network.on("stabilizationIterationsDone", function () {
                 console.log("Graph stabilization complete.");
                 // Maybe fit after initial load / stabilization
                 network.fit({ animation: { duration: 500, easingFunction: 'easeInOutQuad' }});
            });

            network.on("click", function (params) {
                console.log('Graph element clicked:', params);
            });

            // Ensure graph resizes when container resizes
             window.addEventListener('resize', () => {
                 if (network) {
                     network.redraw(); // Redraw the network
                     network.fit();    // Optional: refit after redraw
                 }
             });
        }

        // UI Update Functions
        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status-bar ${type}`; // Make sure class includes 'status-bar'
        }

        // Socket.IO Event Handlers
        socket.on('connect', () => {
            updateStatus('Connected to server. Ready.');
            console.log('Socket.IO connected');
        });

        socket.on('disconnect', () => {
            updateStatus('Disconnected from server.', 'error');
            console.log('Socket.IO disconnected');
        });

        socket.on('connect_error', (err) => {
            updateStatus(`Connection Error: ${err.message}`, 'error');
            console.error('Socket.IO connection error:', err);
        });

        socket.on('update_graph', (data) => {
            console.log("Received graph update:", data);

            if (data && Array.isArray(data.nodes) && Array.isArray(data.edges)) {
                updateStatus(`Graph updated: ${data.nodes.length} nodes, ${data.edges.length} edges.`);

                // Use batch processing for potentially better performance on large updates
                let nodesToRemove = [];
                nodes.getIds().forEach(id => {
                    if (!data.nodes.find(n => n.id === id)) {
                        nodesToRemove.push(id);
                    }
                });

                let edgesToRemove = [];
                edges.getIds().forEach(id => {
                     const edge = edges.get(id);
                     if (!data.edges.find(e => e.from === edge.from && e.to === edge.to && e.label === edge.label)) { // Assuming edges don't have stable IDs from server
                         edgesToRemove.push(id);
                     }
                });

                nodes.remove(nodesToRemove);
                edges.remove(edgesToRemove);
                nodes.update(data.nodes);
                edges.update(data.edges);


            } else {
                console.error("Received invalid graph data format:", data);
                updateStatus('Received invalid graph data.', 'error');
            }
        });

        socket.on('query_result', (data) => {
            console.log("Received query result:", data);
            if (data.error) {
                queryResult.textContent = `Error: ${data.answer}`;
                queryResult.style.color = 'red';
            } else if (data.processing) {
                 queryResult.textContent = data.answer;
                 queryResult.style.color = 'grey';
            }
            else {
                queryResult.textContent = data.answer;
                queryResult.style.color = 'black';
            }
        });

        socket.on('error', (data) => {
            console.error("Server error:", data.message);
            updateStatus(`Server Error: ${data.message}`, 'error');
        });

        socket.on('info', (data) => {
            console.info("Server info:", data.message);
            updateStatus(data.message, 'info');
        });

        // Event Listeners
        submitQueryBtn.addEventListener('click', () => {
            const query = queryInput.value.trim();
            if (query) {
                queryResult.textContent = 'Sending query...';
                queryResult.style.color = 'grey';
                console.log(`Emitting query_graph event with query: ${query}`);
                socket.emit('query_graph', { query: query });
                // queryInput.value = ''; // Keep query input for reference? Or clear it.
            } else {
                queryResult.textContent = 'Please enter a query.';
                queryResult.style.color = 'orange';
            }
        });

        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitQueryBtn.click();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeGraph();
            updateStatus('Connecting to server...');
        });
    </script>
</body>
</html>